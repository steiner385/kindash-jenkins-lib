#!/usr/bin/env groovy
/**
 * KinDash Multi-Branch Pipeline
 *
 * Simplified CI pipeline: Lint, Unit Tests, Build
 *
 * Multi-branch Jenkins provides these environment variables automatically:
 *   BRANCH_NAME   - Current branch name
 *   CHANGE_ID     - PR number (null if not a PR build)
 *
 * Webhook Setup:
 *   URL: https://jenkins.kindash.com/github-webhook/
 *   Content type: application/json
 *   Events: Push, Pull requests
 */

// Load shared library from GitHub
library identifier: 'kindash-lib@main',
    retriever: modernSCM([
        $class: 'GitSCMSource',
        remote: 'https://github.com/steiner385/kindash-jenkins-lib.git',
        credentialsId: 'github-credentials'
    ])

pipeline {
    agent any

    environment {
        GITHUB_OWNER = 'steiner385'
        GITHUB_REPO = 'KinDash'
        CI = 'true'
        NODE_ENV = 'test'
        NODE_OPTIONS = '--max-old-space-size=6144'

        // Multi-branch provides BRANCH_NAME, CHANGE_ID, CHANGE_TARGET automatically
    }

    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timeout(time: 60, unit: 'MINUTES')
        disableConcurrentBuilds(abortPrevious: true)
    }

    stages {
        stage('Initialize') {
            steps {
                script {
                    // Determine build type for logging and status reporting
                    def buildType = env.CHANGE_ID ? "PR #${env.CHANGE_ID}" : "Branch: ${env.BRANCH_NAME}"
                    echo "=== Multi-Branch Build ==="
                    echo "Build type: ${buildType}"
                    if (env.CHANGE_ID) {
                        echo "PR Title: ${env.CHANGE_TITLE ?: 'N/A'}"
                        echo "PR Author: ${env.CHANGE_AUTHOR ?: 'N/A'}"
                        echo "Target Branch: ${env.CHANGE_TARGET ?: 'N/A'}"
                    }
                    echo "=========================="

                    // Report pending status to GitHub for both contexts
                    // jenkins/ci - our custom status
                    githubStatusReporter(
                        status: 'pending',
                        context: 'jenkins/ci',
                        description: "Build started for ${buildType}"
                    )
                    // continuous-integration/jenkins/* - matches GitHub Branch Source plugin context
                    // The plugin sets this to pending but sometimes fails to update on completion
                    def ciContext = env.CHANGE_ID ? 'continuous-integration/jenkins/pr-head' : 'continuous-integration/jenkins/branch'
                    githubStatusReporter(
                        status: 'pending',
                        context: ciContext,
                        description: "Build started for ${buildType}"
                    )
                }

                // Checkout the KinDash application repo (multi-branch SCM)
                checkout scm

                script {
                    env.GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.GIT_COMMIT = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                installDependencies()
            }
        }

        stage('Build Packages') {
            steps {
                sh 'npm run build:packages || true'
            }
        }

        stage('Lint') {
            steps {
                script {
                    // Make lint non-blocking - report warnings but don't fail the build
                    def lintResult = sh(script: 'npm run lint', returnStatus: true)
                    if (lintResult != 0) {
                        echo "Lint completed with warnings/errors (exit code: ${lintResult})"
                        // Don't fail the build - just report
                        unstable(message: "Lint has warnings")
                    }
                }
            }
        }

        stage('Unit Tests') {
            steps {
                withAwsCredentials {
                    runUnitTests(
                        skipCheckout: true,
                        coverageThreshold: 70
                    )
                }
            }
        }

        stage('Build') {
            steps {
                buildProject(skipCheckout: true)
            }
        }
    }

    post {
        always {
            publishReports(
                junit: true,
                allure: true,
                coverage: true
            )
        }
        success {
            script {
                def buildType = env.CHANGE_ID ? "PR #${env.CHANGE_ID}" : env.BRANCH_NAME
                def ciContext = env.CHANGE_ID ? 'continuous-integration/jenkins/pr-head' : 'continuous-integration/jenkins/branch'

                // Report success to both contexts
                githubStatusReporter(
                    status: 'success',
                    context: 'jenkins/ci',
                    description: "Build succeeded for ${buildType}"
                )
                githubStatusReporter(
                    status: 'success',
                    context: ciContext,
                    description: "This commit looks good"
                )

                // Enable auto-merge for PR builds
                if (env.CHANGE_ID) {
                    autoMergePullRequest(mergeMethod: 'SQUASH')
                }
            }
        }
        failure {
            script {
                def buildType = env.CHANGE_ID ? "PR #${env.CHANGE_ID}" : env.BRANCH_NAME
                def ciContext = env.CHANGE_ID ? 'continuous-integration/jenkins/pr-head' : 'continuous-integration/jenkins/branch'

                // Report failure to both contexts
                githubStatusReporter(
                    status: 'failure',
                    context: 'jenkins/ci',
                    description: "Build failed for ${buildType}"
                )
                githubStatusReporter(
                    status: 'failure',
                    context: ciContext,
                    description: "This commit failed tests or other validations"
                )
            }
        }
        cleanup {
            cleanWs()
        }
    }
}
